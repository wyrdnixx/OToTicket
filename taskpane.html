<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OToTicket EWS</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: #f5f5f5;
    }
    .container { 
      max-width: 500px; 
      padding: 20px; 
      background: #fff; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .form-group { 
      margin-bottom: 16px; 
    }
    .form-label { 
      font-weight: 600; 
      margin-bottom: 6px; 
      display: block; 
      color: #323130;
    }
    .form-input, select { 
      width: 100%; 
      padding: 10px; 
      border: 1px solid #d1d1d1; 
      border-radius: 4px; 
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .form-input:focus, select:focus {
      border-color: #0078d4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
    }
    .btn { 
      padding: 12px 20px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: 600; 
      margin-right: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-primary { 
      background: #0078d4; 
      color: #fff; 
    }
    .btn-primary:hover:not(:disabled) {
      background: #106ebe;
    }
    .btn-secondary { 
      background: #6c757d; 
      color: #fff; 
    }
    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
    }
    .btn-success {
      background: #28a745;
      color: #fff;
    }
    .btn-success:hover:not(:disabled) {
      background: #218838;
    }
    .info { 
      margin-bottom: 10px; 
      padding: 12px; 
      background: #cce7ff; 
      color: #004578; 
      border-radius: 4px;
      border-left: 4px solid #0078d4;
    }
    .error { 
      margin-bottom: 10px; 
      padding: 12px; 
      background: #fde7e9; 
      color: #721c24; 
      border-radius: 4px;
      border-left: 4px solid #dc3545;
    }
    .success { 
      margin-bottom: 10px; 
      padding: 12px; 
      background: #d4edda; 
      color: #155724; 
      border-radius: 4px;
      border-left: 4px solid #28a745;
    }
    .warning {
      margin-bottom: 10px; 
      padding: 12px; 
      background: #fff3cd; 
      color: #856404; 
      border-radius: 4px;
      border-left: 4px solid #ffc107;
    }
    .debug { 
      margin-top: 10px; 
      padding: 12px; 
      background: #f8f9fa; 
      color: #495057; 
      border-radius: 4px; 
      font-size: 12px; 
      max-height: 250px; 
      overflow-y: auto;
      border: 1px solid #dee2e6;
    }
    .status { 
      margin-bottom: 10px; 
      padding: 12px; 
      background: #e9ecef; 
      color: #495057; 
      border-radius: 4px; 
      font-size: 13px;
      display: flex;
      align-items: center;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #dee2e6;
      border-top: 2px solid #0078d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
    }
    .ticket-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-top: 10px;
    }
    .ticket-item {
      padding: 10px;
      border-bottom: 1px solid #f1f1f1;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .ticket-item:hover {
      background-color: #f8f9fa;
    }
    .ticket-item.selected {
      background-color: #e6f4ff;
      border-color: #0078d4;
    }
    .ticket-item:last-child {
      border-bottom: none;
    }
    .search-input {
      margin-bottom: 8px;
    }
    .input-group {
      position: relative;
    }
    .input-validation {
      font-size: 12px;
      margin-top: 4px;
      min-height: 16px;
    }
    .input-validation.valid {
      color: #28a745;
    }
    .input-validation.invalid {
      color: #dc3545;
    }
    h2 {
      margin-top: 0;
      color: #323130;
      font-size: 20px;
    }
    h3 {
      color: #323130;
      font-size: 16px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìß Mail2Ticket EWS</h2>
    <div id="status" class="status">
      <div class="spinner"></div>
      Lade Office.js...
    </div>
    <div id="notifications"></div>

    <div class="form-group">
      <label class="form-label">üé´ Ticket Nummer (16 Ziffern)</label>
      <div class="input-group">
        <input 
          type="text" 
          id="ticket" 
          class="form-input" 
          maxlength="16" 
          pattern="[0-9]*" 
          placeholder="z.B. 1234"
          oninput="validateTicket()"
        />
        <div id="ticketValidation" class="input-validation"></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">üìÅ Zielordner</label>
      <select id="folderSelect" class="form-input">
        <option value="">üîÑ Lade Ordner...</option>
      </select>
    </div>

    <div style="margin-bottom: 16px;">
      <button class="btn btn-primary" onclick="copyEmail()" disabled id="copyBtn">
        üìã E‚ÄëMail kopieren
      </button>
      <button class="btn btn-secondary" onclick="closeDialog()" id="cancelBtn">
        ‚ùå Abbrechen
      </button>
    </div>
    
    <div class="checkbox-group">
      <input type="checkbox" id="debugMode" onchange="toggleDebug()">
      <label for="debugMode">üêõ Debug-Modus</label>
    </div>
    <div id="debugOutput" class="debug" style="display: none;"></div>
  </div>

  <div class="container">
    <h3>üîç Ticket Suche</h3>
    <div class="form-group">
      <input 
        type="text" 
        id="searchInput" 
        class="form-input search-input" 
        placeholder="Nach Tickets suchen..."
        oninput="debounceSearch()"
      >
      <button class="btn btn-success" id="ticketSearchBtn" onclick="fetchTickets()">
        üîç Suchen
      </button>
    </div>

    <div id="ticketList" class="ticket-list" style="display: none;"></div>
    <div id="selectedTicket" style="margin-top: 10px; display: none; padding: 10px; background: #e6f4ff; border-radius: 4px;">
      <strong>Ausgew√§hltes Ticket:</strong> <span id="selectedTicketInfo"></span>
    </div>
  </div>

  <script>
    let emailData = {};
    let debugMode = false;
    let officeReady = false;
    let initTimeout;
    let searchTimeout;

    // Enhanced status updates with spinner control
    function updateStatus(message, showSpinner = false) {
      const statusDiv = document.getElementById('status');
      const spinner = showSpinner ? '<div class="spinner"></div>' : '';
      statusDiv.innerHTML = spinner + message;
      debugLog('Status: ' + message);
    }

    function validateTicket() {
      const ticketInput = document.getElementById('ticket');
      const validation = document.getElementById('ticketValidation');
      const value = ticketInput.value;
      
      if (value === '') {
        validation.textContent = '';
        validation.className = 'input-validation';
      } else if (/^[0-9]{16}$/.test(value)) {
        validation.textContent = '‚úì G√ºltige Ticket-Nummer';
        validation.className = 'input-validation valid';
      } else if (/^[0-9]{1,16}$/.test(value)) {
        validation.textContent = `Noch ${16 - value.length} Ziffer(n) ben√∂tigt`;
        validation.className = 'input-validation invalid';
      } else {
        validation.textContent = '‚úó Nur 16 Ziffern erlaubt';
        validation.className = 'input-validation invalid';
      }
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      const query = document.getElementById('searchInput').value.trim();
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(() => fetchTickets(query), 300);
      } else if (query.length === 0) {
        document.getElementById('ticketList').style.display = 'none';
        document.getElementById('selectedTicket').style.display = 'none';
      }
    }

    function toggleDebug() {
      debugMode = document.getElementById('debugMode').checked;
      const debugOutput = document.getElementById('debugOutput');
      debugOutput.style.display = debugMode ? 'block' : 'none';
      if (!debugMode) debugOutput.innerHTML = '';
    }

    function debugLog(message) {
      if (debugMode) {
        const debugOutput = document.getElementById('debugOutput');
        const timestamp = new Date().toLocaleTimeString();
        debugOutput.innerHTML += `<div><strong>${timestamp}:</strong> ${message}</div>`;
        debugOutput.scrollTop = debugOutput.scrollHeight;
      }
      console.log('OToTicket: ' + message);
    }

    function notify(type, text, autoHide = false) {
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = text;
      const nm = document.getElementById('notifications');
      nm.innerHTML = '';
      nm.appendChild(div);
      debugLog(`Notification (${type}): ${text}`);
      
      if (autoHide) {
        setTimeout(() => {
          if (div.parentNode) {
            div.parentNode.removeChild(div);
          }
        }, 5000);
      }
    }

    function escapeXml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }

    // Enhanced initialization with better error handling
    function initializeAddin() {
      debugLog('Initializing addin...');
      updateStatus('Initialisiere Add-in...', true);

      initTimeout = setTimeout(function() {
        if (!officeReady) {
          debugLog('Office.js timeout - trying fallback initialization');
          updateStatus('Office.js Timeout - versuche Fallback...', true);
          fallbackInitialization();
        }
      }, 10000);

      if (typeof Office !== 'undefined') {
        debugLog('Office object found, calling Office.onReady');
        Office.onReady(function(info) {
          handleOfficeReady(info);
        });
      } else {
        debugLog('Office object not found, waiting...');
        setTimeout(function() {
          if (typeof Office !== 'undefined') {
            Office.onReady(function(info) {
              handleOfficeReady(info);
            });
          } else {
            fallbackInitialization();
          }
        }, 2000);
      }
    }

    function handleOfficeReady(info) {
      clearTimeout(initTimeout);
      officeReady = true;
      
      debugLog('Office.onReady called successfully');
      debugLog('Host: ' + (info ? info.host : 'unknown'));
      debugLog('Platform: ' + (info ? info.platform : 'unknown'));
      
      updateStatus('Office.js geladen - lade E-Mail Daten...', true);

      if (!Office.context || !Office.context.mailbox) {
        debugLog('No mailbox context available');
        updateStatus('‚ùå Fehler: Kein Mailbox-Kontext verf√ºgbar');
        notify('error', 'Add-in nicht im korrekten E-Mail-Kontext gestartet');
        return;
      }

      document.getElementById('copyBtn').disabled = false;
      loadEmailData();
      loadFolders();
    }

    function fallbackInitialization() {
      debugLog('Fallback initialization');
      updateStatus('Fallback-Initialisierung...', true);
      
      if (typeof Office === 'undefined' || 
          !Office.context || 
          !Office.context.mailbox) {
        updateStatus('‚ùå Fehler: Office.js nicht verf√ºgbar');
        notify('error', 'Office.js konnte nicht geladen werden. Bitte Add-in neu starten.');
        return;
      }

      officeReady = true;
      document.getElementById('copyBtn').disabled = false;
      loadEmailData();
      loadFolders();
    }

    function loadEmailData() {
      debugLog('Loading email data...');
      
      try {
        const item = Office.context.mailbox.item;
        if (!item) {
          debugLog('No mail item available');
          updateStatus('‚ùå Fehler: Keine E-Mail ausgew√§hlt');
          return;
        }

        emailData.subject = item.subject || '';
        emailData.body = '';
        emailData.to = item.to || [];
        emailData.sender = item.sender || {};
        
        debugLog('Email subject: ' + emailData.subject);
        debugLog('Email sender: ' + emailData.sender.emailAddress);

        item.body.getAsync('html', function(res) {
          if (res.status === Office.AsyncResultStatus.Succeeded) {
            emailData.body = res.value;
            debugLog('Email body loaded successfully');
          } else {
            debugLog('Error loading email body: ' + (res.error ? res.error.message : 'Unknown error'));
          }
        });

        updateStatus('üìß E-Mail Daten geladen - lade Ordner...', true);
        
      } catch (error) {
        debugLog('Error in loadEmailData: ' + error.message);
        updateStatus('‚ùå Fehler beim Laden der E-Mail Daten');
        notify('error', 'Fehler beim Laden der E-Mail Daten: ' + error.message);
      }
    }

    function loadFolders() {
      debugLog('Starting to load folders...');
      
      try {
        const soapRequest = `<?xml version="1.0" encoding="utf-8"?>
          <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
                         xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"
                         xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages">
            <soap:Header>
              <t:RequestServerVersion Version="Exchange2013" />
            </soap:Header>
            <soap:Body>
              <m:FindFolder Traversal="Shallow">
                <m:FolderShape>
                  <t:BaseShape>Default</t:BaseShape>
                </m:FolderShape>
                <m:ParentFolderIds>
                  <t:DistinguishedFolderId Id="msgfolderroot" />
                </m:ParentFolderIds>
              </m:FindFolder>
            </soap:Body>
          </soap:Envelope>`;

        debugLog('Sending EWS request...');
        
        Office.context.mailbox.makeEwsRequestAsync(soapRequest, function (result) {
          debugLog('EWS request completed with status: ' + result.status);
          
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            debugLog('EWS request successful');
            processFolderResponse(result.value);
          } else {
            const errorMsg = result.error ? result.error.message : 'Unbekannter Fehler';
            debugLog('EWS request failed: ' + errorMsg);
            updateStatus('‚ùå Fehler beim Laden der Ordner');
            notify('error', 'Ordner konnten nicht geladen werden: ' + errorMsg);
            addFallbackFolders();
          }
        });
        
      } catch (error) {
        debugLog('Error in loadFolders: ' + error.message);
        updateStatus('‚ùå Fehler beim Laden der Ordner');
        notify('error', 'Fehler beim Laden der Ordner: ' + error.message);
        addFallbackFolders();
      }
    }

    function processFolderResponse(xmlResponse) {
      debugLog('Processing folder response...');
      
      try {
        const folderSelect = document.getElementById("folderSelect");
        folderSelect.innerHTML = '<option value="">üìÅ Bitte w√§hlen</option>';

        const xmlDoc = new DOMParser().parseFromString(xmlResponse, "text/xml");
        const folders = xmlDoc.getElementsByTagNameNS("http://schemas.microsoft.com/exchange/services/2006/types", "Folder");
        
        debugLog(`Found ${folders.length} folders`);

        let addedFolders = 0;
        for (let i = 0; i < folders.length; i++) {
          const folder = folders[i];
          const displayNameElem = folder.getElementsByTagNameNS("http://schemas.microsoft.com/exchange/services/2006/types", "DisplayName")[0];
          const folderIdElem = folder.getElementsByTagNameNS("http://schemas.microsoft.com/exchange/services/2006/types", "FolderId")[0];

          if (!displayNameElem || !folderIdElem) continue;

          const displayName = displayNameElem.textContent;
          const folderId = folderIdElem.getAttribute("Id");
          const changeKey = folderIdElem.getAttribute("ChangeKey") || "";

          if (displayName.startsWith("~") || displayName === "Conversation Action Settings") {
            continue;
          }

          const value = folderId + ";" + changeKey;
          const option = document.createElement("option");
          option.value = value;
          option.textContent = displayName;
          folderSelect.appendChild(option);
          addedFolders++;
        }

        const savedFolder = Office.context.roamingSettings.get("lastSelectedFolder");
        if (savedFolder) {
          folderSelect.value = savedFolder;
        }

        updateStatus(`‚úÖ ${addedFolders} Ordner geladen - bereit`);
        notify('success', `${addedFolders} Ordner erfolgreich geladen`, true);
        
      } catch (error) {
        debugLog('Error processing folders: ' + error.message);
        updateStatus('‚ùå Fehler beim Verarbeiten der Ordner');
        addFallbackFolders();
      }
    }

    function addFallbackFolders() {
      debugLog('Adding fallback folders...');
      const folderSelect = document.getElementById("folderSelect");
      folderSelect.innerHTML = '<option value="">üìÅ Bitte w√§hlen</option>';
      
      const fallbackFolders = [
        { name: "üì• Posteingang", id: "inbox;" },
        { name: "üì§ Gesendete Objekte", id: "sentitems;" },
        { name: "üìù Entw√ºrfe", id: "drafts;" }
      ];
      
      fallbackFolders.forEach(folder => {
        const option = document.createElement("option");
        option.value = folder.id;
        option.textContent = folder.name;
        folderSelect.appendChild(option);
      });
      
      updateStatus('‚ö†Ô∏è Fallback-Ordner geladen - bereit');
      notify('warning', 'Standard-Ordner geladen (Ordner-Laden fehlgeschlagen)', true);
    }

    function copyEmail() {
      debugLog('Copy email function called');
      
      if (!officeReady) {
        notify('error', 'Add-in noch nicht bereit');
        return;
      }

      const ticket = document.getElementById('ticket').value.trim();
      const folderSelect = document.getElementById('folderSelect');
      const folderValue = folderSelect.value;

      if (!/^[0-9]{16}$/.test(ticket)) {
        notify('error', '‚ùå Ticket muss genau 16 Ziffern haben');
        document.getElementById('ticket').focus();
        return;
      }
      if (!folderValue) {
        notify('error', '‚ùå Bitte Zielordner ausw√§hlen');
        folderSelect.focus();
        return;
      }

      // Disable button during operation
      const copyBtn = document.getElementById('copyBtn');
      copyBtn.disabled = true;
      copyBtn.textContent = '‚è≥ Kopiere...';

      notify('info', 'üìã E‚ÄëMail wird kopiert‚Ä¶');
      debugLog('Starting email copy process...');

      try {
        const [folderId, changeKey] = folderValue.split(";");
        
        let targetFolder;
        if (folderId === 'inbox') {
          targetFolder = '<t:DistinguishedFolderId Id="inbox" />';
        } else if (folderId === 'sentitems') {
          targetFolder = '<t:DistinguishedFolderId Id="sentitems" />';
        } else if (folderId === 'drafts') {
          targetFolder = '<t:DistinguishedFolderId Id="drafts" />';
        } else {
          targetFolder = `<t:FolderId Id="${escapeXml(folderId)}" ChangeKey="${escapeXml(changeKey)}"/>`;
        }

        const copySoap = `<?xml version="1.0" encoding="utf-8"?>
          <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
                         xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"
                         xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages">
            <soap:Header>
              <t:RequestServerVersion Version="Exchange2013"/>
            </soap:Header>
            <soap:Body>
              <m:CopyItem>
                <m:ToFolderId>
                  ${targetFolder}
                </m:ToFolderId>
                <m:ItemIds>
                  <t:ItemId Id="${escapeXml(Office.context.mailbox.item.itemId)}"/>
                </m:ItemIds>
              </m:CopyItem>
            </soap:Body>
          </soap:Envelope>`;

        Office.context.mailbox.makeEwsRequestAsync(copySoap, function(result) {
          copyBtn.disabled = false;
          copyBtn.textContent = 'üìã E‚ÄëMail kopieren';

          if (result.status === Office.AsyncResultStatus.Succeeded) {
            debugLog('Email copy successful');
            
            const responseXml = new DOMParser().parseFromString(result.value, 'text/xml');
            const copiedItem = responseXml.getElementsByTagName('t:ItemId')[0];
            
            if (copiedItem) {    
              const newItemId = copiedItem.getAttribute('Id');
              const newChangeKey = copiedItem.getAttribute('ChangeKey');
              const newSubject = `[MCB#${ticket}] ${emailData.subject}`;
              updateSubject(newItemId, newChangeKey, newSubject);
            } else {
              notify('success', '‚úÖ E-Mail wurde erfolgreich kopiert');
            }
            
            Office.context.roamingSettings.set("lastSelectedFolder", folderValue);
            Office.context.roamingSettings.saveAsync();
            
          } else {
            const errorMsg = result.error ? result.error.message : 'Unbekannter Fehler';
            notify('error', '‚ùå Fehler beim Kopieren: ' + errorMsg);
            debugLog('Copy error: ' + errorMsg);
          }
        });
        
      } catch (error) {
        copyBtn.disabled = false;
        copyBtn.textContent = 'üìã E‚ÄëMail kopieren';
        debugLog('Error in copyEmail: ' + error.message);
        notify('error', '‚ùå Fehler beim Kopieren: ' + error.message);
      }
    }

    function updateSubject(itemId, changeKey, newSubject) {
      const updateSoap = `
        <soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
                       xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types"
                       xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages">
          <soap:Header>
            <t:RequestServerVersion Version="Exchange2013" />
          </soap:Header>
          <soap:Body>
            <m:UpdateItem MessageDisposition="SaveOnly" ConflictResolution="AutoResolve">
              <m:ItemChanges>
                <t:ItemChange>
                  <t:ItemId Id="${escapeXml(itemId)}" ChangeKey="${escapeXml(changeKey)}"/>
                  <t:Updates>
                    <t:SetItemField>
                      <t:FieldURI FieldURI="item:Subject" />
                      <t:Message>
                        <t:Subject>${escapeXml(newSubject)}</t:Subject>
                      </t:Message>
                    </t:SetItemField>
                  </t:Updates>
                </t:ItemChange>
              </m:ItemChanges>
            </m:UpdateItem>
          </soap:Body>
        </soap:Envelope>`;

      Office.context.mailbox.makeEwsRequestAsync(updateSoap, result => {
        if (result.status === Office.AsyncResultStatus.Succeeded) {
          notify('success', '‚úÖ E-Mail wurde erfolgreich kopiert und Betreff angepasst.', true);
        } else {
          notify('error', '‚ùå Fehler beim Aktualisieren des Betreffs: ' + (result.error ? result.error.message : 'Unbekannt'));
        }
      });
    }

    function closeDialog() {
      debugLog('Close dialog called');
      
      try {
        if (typeof Office !== 'undefined' && 
            Office.context && 
            Office.context.ui && 
            Office.context.ui.closeContainer) {
          Office.context.ui.closeContainer();
        } else if (window.close) {
          window.close();
        } else {
          document.body.style.display = 'none';
        }
      } catch (error) {
        debugLog('Error closing dialog: ' + error.message);
        if (window.close) window.close();
      }
    }

    // Enhanced ticket search with better UX
    async function fetchTickets(query = null) {
      const button = document.getElementById("ticketSearchBtn");
      const ticketList = document.getElementById("ticketList");
      const selectedDiv = document.getElementById("selectedTicket");
      const searchInput = document.getElementById("searchInput");

      const searchQuery = query || searchInput.value.trim();
      
      
      if (!searchQuery) {
        notify('warning', '‚ö†Ô∏è Bitte Suchbegriff eingeben');
        return;
       }

      button.disabled = true;
      button.textContent = "üîÑ Suche...";

      try {          
        //const response = await fetch(`http://localhost:8080/api/tickets/suggestions?q=${encodeURIComponent(searchQuery)}`);
        console.log("Searching for " + emailData.sender.emailAddress); 
        const response = await fetch(`http://localhost:8080/api/tickets/suggestions?q=${encodeURIComponent(searchQuery)}&mail=${encodeURIComponent(emailData.sender.emailAddress)}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const tickets = await response.json();

        ticketList.innerHTML = "";
        selectedDiv.style.display = "none";

        if (tickets.length === 0) {
          ticketList.innerHTML = '<div class="ticket-item" style="text-align: center; color: #6c757d;">Keine Tickets gefunden</div>';
          ticketList.style.display = "block";
          return;
        }

        tickets.forEach(ticket => {
          const div = document.createElement("div");
          div.className = "ticket-item";
          div.innerHTML = `
            <div style="font-weight: 600; color: #0078d4;">#${ticket.tn}</div>
            <div style="margin: 4px 0;">${ticket.title}</div>
            <div style="font-size: 12px; color: #6c757d;">${ticket.name}</div>
          `;
          div.dataset.tn = ticket.tn;

          div.addEventListener("click", () => {
            // Remove previous selection
            document.querySelectorAll(".ticket-item").forEach(el => el.classList.remove("selected"));
            div.classList.add("selected");
            
            // Update ticket input
            document.getElementById("ticket").value = ticket.tn;
            validateTicket();
            
            // Show selection info
            document.getElementById("selectedTicketInfo").textContent = `#${ticket.tn} - ${ticket.title}`;
            selectedDiv.style.display = "block";
            
            notify('success', `‚úÖ Ticket #${ticket.tn} ausgew√§hlt`, true);
          });

          ticketList.appendChild(div);
        });

        ticketList.style.display = "block";
        notify('info', `üîç ${tickets.length} Ticket(s) gefunden`, true);
        
      } catch (err) {
        ticketList.innerHTML = '<div class="ticket-item" style="color: #dc3545; text-align: center;">‚ùå Fehler beim Laden der Tickets</div>';
        ticketList.style.display = "block";
        notify('error', '‚ùå Fehler beim Laden der Tickets: ' + err.message);
        console.error('Ticket search error:', err);
      } finally {
        button.disabled = false;
        button.textContent = "üîç Suchen";
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeAddin);
    } else {
      initializeAddin();
    }

    // Additional fallback after page load
    window.addEventListener('load', function() {
      if (!officeReady) {
        debugLog('Window load event - Office still not ready, trying again...');
        setTimeout(function() {
          if (!officeReady) {
            fallbackInitialization();
          }
        }, 1000);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + Enter to copy email
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        if (!document.getElementById('copyBtn').disabled) {
          copyEmail();
        }
      }
      
      // Escape to close
      if (e.key === 'Escape') {
        closeDialog();
      }
      
      // Enter in search to search
      if (e.key === 'Enter' && e.target.id === 'searchInput') {
        e.preventDefault();
        fetchTickets();
      }
    });

    // Auto-focus ticket input when ready
    function focusTicketInput() {
      if (officeReady) {
        document.getElementById('ticket').focus();
      }
    }

    // Call focus after initialization
    setTimeout(focusTicketInput, 1000);

  </script>
</body>
</html>